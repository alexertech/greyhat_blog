#!/bin/bash

# Docker Compose deployment script
# Deploys to Docker server at 192.168.0.50

set -euo pipefail

# Configuration
DOCKER_SERVER="${DOCKER_SERVER:-192.168.0.50}"
DOCKER_USER="${DOCKER_USER:-alex}"
APP_NAME="${APP_NAME:-greyhat_cl}"
DEPLOY_DIR="/home/$DOCKER_USER/docker/docker_deploy/$APP_NAME"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/home/$DOCKER_USER/docker/backups/$APP_NAME"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}" >&2
}

warn() {
    echo -e "${YELLOW}[WARN] $1${NC}"
}

success() {
    echo -e "${GREEN}[SUCCESS] $1${NC}"
}

# Check if we can connect to the server
log "ğŸ” Checking connection to $DOCKER_SERVER..."
if ! ssh -o ConnectTimeout=10 "$DOCKER_USER@$DOCKER_SERVER" "echo 'Connection successful'" >/dev/null 2>&1; then
    error "Cannot connect to $DOCKER_SERVER. Please check your SSH configuration."
    exit 1
fi

log "ğŸš€ Starting deployment to $DOCKER_SERVER..."

# Validate environment files
if [[ ! -f ".env.production" ]]; then
    warn "No .env.production file found locally."
    warn "Make sure you have a .env.production file on the server at $DEPLOY_DIR"
    warn "Copy .env.example to .env.production and fill in the values."
fi

# Create temporary build archive (excluding more files for security)
log "ğŸ“¦ Creating build archive..."
tar --exclude='.git' \
    --exclude='node_modules' \
    --exclude='tmp' \
    --exclude='log' \
    --exclude='.env*' \
    --exclude='coverage' \
    --exclude='spec' \
    --exclude='test' \
    --exclude='.DS_Store' \
    --exclude='*.tar.gz' \
    -czf "/tmp/$APP_NAME-$TIMESTAMP.tar.gz" .

# Transfer source to Docker server
log "ğŸ“¤ Transferring source to Docker server..."
if ! scp "/tmp/$APP_NAME-$TIMESTAMP.tar.gz" "$DOCKER_USER@$DOCKER_SERVER:/tmp/"; then
    error "Failed to transfer files to server"
    rm "/tmp/$APP_NAME-$TIMESTAMP.tar.gz"
    exit 1
fi

# Deploy on remote server
log "ğŸ”„ Deploying on remote server..."
ssh "$DOCKER_USER@$DOCKER_SERVER" << EOF
    set -euo pipefail

    # Create directories
    mkdir -p "$DEPLOY_DIR" "$BACKUP_DIR"

    # Backup current deployment if it exists
    if [[ -d "$DEPLOY_DIR" && -f "$DEPLOY_DIR/docker-compose.yml" ]]; then
        echo "ğŸ’¾ Creating backup of current deployment..."
        tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$DEPLOY_DIR" . 2>/dev/null || true
    fi

    # Extract source to deployment directory
    cd "$DEPLOY_DIR"
    echo "ğŸ“‚ Extracting source..."
    tar -xzf "/tmp/$APP_NAME-$TIMESTAMP.tar.gz"

    # Stop existing services gracefully
    echo "ğŸ›‘ Stopping existing services..."
    if docker compose ps -q | grep -q .; then
        docker compose down --timeout 30
    fi

    # Pull latest base images
    echo "ğŸ“¥ Pulling latest images..."
    docker compose pull --ignore-buildable || true

    # Check for production environment file
    if [[ ! -f ".env.production" ]]; then
        echo "âš ï¸  No .env.production found. Creating from example..."
        if [[ -f ".env.example" ]]; then
            cp .env.example .env.production
            echo "ğŸ“ Please edit .env.production with your actual values before running again."
            echo "âŒ Deployment cannot continue without proper environment configuration."
            exit 1
        fi
    fi

    # Build and start services with production compose file
    echo "ğŸ—ï¸  Building and starting services..."
    docker compose --env-file .env.production -f docker-compose.yml up -d --build --remove-orphans

    # Wait for services to be healthy
    echo "â³ Waiting for services to be healthy..."
    timeout 300 docker compose wait || {
        echo "âŒ Services failed to become healthy within 5 minutes"
        docker compose logs --tail=50
        exit 1
    }

    # Run database migrations
    echo "ğŸ”„ Running database migrations..."
    docker compose exec -T web bundle exec rails db:migrate || {
        echo "âŒ Database migration failed"
        docker compose logs web --tail=20
        exit 1
    }

    # Clean up
    rm "/tmp/$APP_NAME-$TIMESTAMP.tar.gz"

    # Show deployment status
    echo "ğŸ“Š Deployment status:"
    docker compose ps

    echo "ğŸ“ Deployment saved to $DEPLOY_DIR"
    echo "ğŸ’¾ Backup saved to $BACKUP_DIR/backup_$TIMESTAMP.tar.gz"
EOF

# Clean up local tar file
rm "/tmp/$APP_NAME-$TIMESTAMP.tar.gz"

success "ğŸ‰ Deployment complete!"
log "ğŸ“‹ Next steps:"
log "  - Check application logs: ssh $DOCKER_USER@$DOCKER_SERVER 'cd $DEPLOY_DIR && docker compose logs -f web'"
log "  - Monitor health: ssh $DOCKER_USER@$DOCKER_SERVER 'cd $DEPLOY_DIR && docker compose ps'"
